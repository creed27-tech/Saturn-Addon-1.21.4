package dev.saturn.addon.modules.Exploit;

import dev.saturn.addon.Saturn;
import meteordevelopment.meteorclient.settings.*;
import meteordevelopment.meteorclient.systems.modules.Module;
import meteordevelopment.meteorclient.systems.modules.Category;
import meteordevelopment.meteorclient.events.packets.PacketEvent;
import meteordevelopment.orbit.EventHandler;
import net.minecraft.network.packet.c2s.play.ClientCommandC2SPacket;
import net.minecraft.network.packet.c2s.play.PlayerActionC2SPacket;
import net.minecraft.network.packet.c2s.play.PlayerMoveC2SPacket;
import net.minecraft.network.packet.c2s.play.PlayerMoveC2SPacket.Full;
import net.minecraft.util.math.BlockPos;

public class AntiHunger extends Module {
    private final SettingGroup sgGeneral = settings.getDefaultGroup();

    private final Setting<Boolean> noSprint = sgGeneral.add(new BoolSetting.Builder()
            .name("no-sprint")
            .description("Prevents hunger decrease by disabling server-side sprinting.")
            .defaultValue(true)
            .build()
    );

    private final Setting<Boolean> keepFloating = sgGeneral.add(new BoolSetting.Builder()
            .name("keep-floating")
            .description("Prevents hunger decrease by simulating constant falling.")
            .defaultValue(true)
            .build()
    );

    private long notificationCooldown = 0;

    public AntiHunger() {
        super(Saturn.Exploit, "anti-hunger", "Prevents hunger from decreasing. | Ported from LiquidBounce");
    }

    @EventHandler
    private void onPacketSend(PacketEvent.Send event) {
        if (event.packet instanceof ClientCommandC2SPacket packet) {
            if (noSprint.get() && packet.getMode() == ClientCommandC2SPacket.Mode.START_SPRINTING) {
                if (System.currentTimeMillis() - notificationCooldown > 500) {
                    warning("Sprinting might affect AntiHunger.");
                    notificationCooldown = System.currentTimeMillis();
                }
                event.cancel(); // Cancel sprinting
            }
        }

        if (event.packet instanceof PlayerActionC2SPacket packet) {
            if (packet.getAction() == PlayerActionC2SPacket.Action.START_DESTROY_BLOCK) {
                if (System.currentTimeMillis() - notificationCooldown > 500) {
                    warning("Block breaking might affect AntiHunger.");
                    notificationCooldown = System.currentTimeMillis();
                }
            }
        }

        if (event.packet instanceof PlayerMoveC2SPacket packet) {
            if (keepFloating.get() && mc.player != null) {
                if (!mc.player.hasVehicle() && !mc.player.isTouchingWater() && !mc.player.isSwimming() && !mc.player.isSubmergedInWater()) {
                    if (packet instanceof Full movePacket) {
                        if (movePacket.isOnGround() && mc.player.fallDistance <= 0.0) {
                            movePacket.isOnGround(); // Simulate floating
                        }
                    }
                }
            }
        }
    }

    private void warning(String message) {
        info("[AntiHunger] " + message);
    }
}